<template>
    <div class="signup">
    <div class="frame-2">
      <div class="rectangle-22"></div>
      <router-link to="/main">
        <div class="tong">TONG</div>
      </router-link>
      <div class="frame-3">
  <div class="id">
    <!-- idì™€ name ì†ì„± ì¶”ê°€ -->
    <input 
      type="text" 
      v-model="userId" 
      placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
      class="input-field" 
      id="userId" 
      name="userId" 
    />
  </div>
  <div class="password">
    <!-- idì™€ name ì†ì„± ì¶”ê°€ -->
    <input
      :type="passwordType"
      v-model="userPassword"
      placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      class="input-field"
      id="userPassword"
      name="userPassword"
    />
    <span class="toggle-password" @click="togglePasswordVisibility" style="font-size: 28px;">
      {{ isPasswordVisible ? "ğŸ”‘" : "ğŸ”’" }}
    </span>    
  </div>
  <div class="login-btn">
    <button type="button" @click="login" class="login-button">ë¡œê·¸ì¸</button>
  </div>
  <img
      src="https://image-resource.creatie.ai/142625939968981/142625939968983/c131a7373ebf8184425abc238dab0d0b.png"
      class="kakao-login-large-narrow-1"
      @click="redirectToKakaoLogin"
    />
</div>



            <div class="frame-5">
                <div class="group-104">
                    <router-link to="/signUp">
                            <div class="text--3">
                                íšŒì›ê°€ì…
                            </div>
                    </router-link>
                    <div class="text--with-kakao" @click="redirectToKakaoLogin" style="z-index: 1; position: relative;">
                        íšŒì›ê°€ì… with KAKAO
                    </div>
                </div>
            </div>

        </div>
    </div>
</template>


<style lang="scss">
    .signup {
        background-image: url('../assets/images/background.png'); /* ì‹¤ì œ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ë„£ì–´ì£¼ì„¸ìš” */
  background-size: cover;   /* ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
  background-position: center; /* ë°°ê²½ ì´ë¯¸ì§€ê°€ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
  background-repeat: no-repeat; /* ë°°ê²½ ì´ë¯¸ì§€ ë°˜ë³µ ë°©ì§€ */


    position: relative;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100vh;
    box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
    overflow: hidden;
    .rectangle-21 {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100vh;
        background: linear-gradient(180deg, rgba(47, 47, 47, 0.8) 0%, rgba(78, 78, 78, 0.8) 50%, rgba(149, 149, 149, 0.8) 100%);
    }
    .group {
        position: absolute;
        top: 1.37%;
        left: 0.69%;
        right: -0.14%;
        bottom: 5.47%;
    }
    .group-52 {
        position: absolute;
        top: 1.37%;
        left: 0.69%;
        right: -0.14%;
        bottom: 5.47%;
    }
    .frame-2 {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 807px;
        height: 871px;
        border-radius: 20px;
        overflow: hidden;
        transform: translate(-50%, -50%);  /* í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™ */
        .rectangle-22 {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, rgba(197, 197, 197, 0.21) 0%, rgba(197, 197, 197, 0.21) 6%, rgba(113, 113, 113, 0.21) 46%, rgba(95, 95, 95, 0.21) 100%);
        }
        .tong {
            z-index: 2;
            position: absolute;
            top: 12px;
            left: 309.5px;
            width: 190px;
            height: 134px;
            color: #E2495B;
            white-space: nowrap;
            font-family: "Jockey One";
            font-size: 96px;
            line-height: 134px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;

            transition: transform 0.3s ease;
            

            &:hover {
            transform: scale(1.05);
            }
        }
        
        .frame-3 {
    z-index: 1;
    position: absolute;
    top: 121px;
    left: 71px;
    width: 676px;
    height: 558px;
    border-radius: 10px;
    overflow: hidden;
}

.id {
    position: absolute;
    top: 85px;
    left: calc(100% - 676px + 106px);
    width: 463px;
    height: 79px;
    border-radius: 10px;
    border: 3px solid #FFFFFF;
    display: flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.2);
}

.password {
    position: absolute;
    top: 221px;
    left: 106px;
    width: 463px;
    height: 79px;
    border-radius: 10px;
    border: 3px solid #FFFFFF;
    display: flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.2);
}

.input-field {
    width: 100%;
    height: 100%;
    padding: 0 20px;
    background: transparent;
    border: none;
    outline: none;
    color: #FFFFFF;
    font-size: 28px;
    font-family: "Jockey One";
    line-height: 22px;
    font-weight: 400;
    border-radius: 10px;
    color: black;
}

/* ë¡œê·¸ì¸ ë²„íŠ¼ */
.login-btn {
    position: absolute;
    top: 325px;
    left: calc(100% - 676px + 107px);
    width: 463px;
    height: 79px;
    border-radius: 10px;
    // background: rgba(226, 73, 91, 0.9);
    border: 1px solid rgba(226, 73, 91, 0);
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to right, #dc606f 0%, #e2495b 100%);
    background-size: 200% auto; /* ë°°ê²½ í¬ê¸° ì¡°ì • */
    transition: all 0.3s ease, background-position 0.5s ease;

    &:hover {
      transform: translateY(-1px); /* ì‚´ì§ ìœ„ë¡œ ì´ë™í•˜ëŠ” íš¨ê³¼ */
    background-position: right center; /* ë°°ê²½ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ */
    background-image: linear-gradient(to right, #fbc2eb 0%, #a6c1ee 51%, #fbc2eb 100%);
  }
}

.login-button {
    width: 100%;
    height: 100%;
    background: transparent;
    color: #FFFFFF;
    font-size: 36px;
    font-family: "Jockey One";
    border: none;
    cursor: pointer;
    border-radius: 10px;
    text-align: center;
}

.text--2 {
    position: absolute;
    top: 340px;
    left: calc(100% - 676px + 289px);
    width: 99px;
    height: 50px;
    color: #FFFFFF;
    white-space: nowrap;
    font-family: "Jockey One";
    font-size: 36px;
    line-height: 50px;
    font-weight: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.kakao-login-large-narrow-1 {
  position: absolute;
  top: 418px;
  left: 107px;
  width: 463px;
  height: 76px;
  border-radius: 10px;
  object-fit: cover;
  transition: all 0.5s ease;

}

.kakao-login-large-narrow-1:hover {
  // background-position: right center; /* hover ì‹œ ë°°ê²½ ì´ë™ */
  transform: translateY(-1px); /* ì‚´ì§ ìœ„ë¡œ ì´ë™í•˜ëŠ” íš¨ê³¼ */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* ì•½ê°„ì˜ ê·¸ë¦¼ì íš¨ê³¼ */
  cursor: pointer;
}



        .frame-5 {
            position: absolute;
            left: calc(100% - 807px + 101px);
            bottom: 85px;
            width: 606px;
            height: 82px;
            overflow: hidden;
            .group-104 {
                position: absolute;
                top: 30px;
                left: 195px;
                width: 264px;
                height: 22px;
                .text--3 {
                    position: absolute;
                    top: 0px;
                    left: 0px;
                    width: 57px;
                    height: 22px;
                    color: #000000;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
                .text--4 {
                    position: absolute;
                    top: 0px;
                    left: 0px;
                    width: 57px;
                    height: 22px;
                    color: #FFFFFF;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
                .text--with-kakao {
                    position: absolute;
                    top: 0px;
                    left: 142px;
                    width: 122px;
                    height: 22px;
                    color: #000000;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;

                }
            }
        }
    }
}
</style>



<script setup>
import { ref, computed, onMounted } from "vue";
import axios from "axios";
import { useRouter } from "vue-router";
import { useUserStore } from '../stores/user';

// ìƒíƒœ ë³€ìˆ˜ë“¤
const userId = ref("");
const userPassword = ref("");
const isPasswordVisible = ref(false);
const router = useRouter();
const userStore = useUserStore();

// ë¹„ë°€ë²ˆí˜¸ íƒ€ì… computed ì†ì„±
const passwordType = computed(() => (isPasswordVisible.value ? "text" : "password"));

// ë¹„ë°€ë²ˆí˜¸ í† ê¸€ í•¨ìˆ˜
const togglePasswordVisibility = () => {
  isPasswordVisible.value = !isPasswordVisible.value;
};

// ì¼ë°˜ ë¡œê·¸ì¸ í•¨ìˆ˜
const login = async () => {
  if (!userId.value || !userPassword.value) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  try {
    const response = await axios.post(
      `${import.meta.env.VITE_API_BASE_URL}/api/user/signIn`,
      {
        userId: userId.value,
        password: userPassword.value,
      },
      {
        withCredentials: true,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      }
    );

    if (response.data && response.data["access-token"]) {
      // í† í° ì €ì¥
      userStore.saveTokenToStorage(response.data["access-token"]);
      
      // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      await userStore.fetchUserInfo();
      
      alert("ë¡œê·¸ì¸ ì„±ê³µ!");
      router.push({ name: "main" });
    } else {
      alert(response.data.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    }
  } catch (error) {
    console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
  }
};


// ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸
const redirectToKakaoLogin = () => {
  const { VITE_KAKAO_CLIENT_ID } = import.meta.env;
  const REDIRECT_URI = `${import.meta.env.VITE_API_BASE_URL}/oauth2/kakao`;
  
  // ì¹´ì¹´ì˜¤ ì¸ê°€ ì½”ë“œ ìš”ì²­ URL ìƒì„±
  const kakaoAuthUrl = 'https://kauth.kakao.com/oauth/authorize';
  const params = {
    client_id: VITE_KAKAO_CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'code',
  };
  const query = new URLSearchParams(params).toString();
  const finalUrl = `${kakaoAuthUrl}?${query}`;
  
  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  window.location.href = finalUrl;
};

// ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì½œë°± ì²˜ë¦¬ í•¨ìˆ˜
const handleKakaoCallback = async (code) => {
  try {
    const response = await axios.get(
      `${import.meta.env.VITE_API_BASE_URL}/oauth2/kakao?code=${code}`,
      {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (response.data) {
      const responseData = typeof response.data === 'string' 
        ? JSON.parse(response.data) 
        : response.data;

      if (responseData.access_token) {
        userStore.saveKakaoTokenToStorage(responseData.access_token);
        
        try {
          const userInfoResponse = await axios.get(
            `${import.meta.env.VITE_API_BASE_URL}/oauth2/kakao/user-info`,
            {
              headers: {
                'Authorization': `Bearer ${responseData.access_token}`,
                'Accept': 'application/json'
              }
            }
          );

          console.log('ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´:', userInfoResponse.data);

          if (userInfoResponse.status === 201) {
            router.push({ name: "signUp" });
          } else {
            // userType ì„¤ì •
            const userType = userInfoResponse.data.userType;
            if (userType) {
              userStore.setUserType(userType);
              console.log('ì„¤ì •ëœ userType:', userType); // ë””ë²„ê¹…ìš©
            }
            await userStore.fetchUserInfo();
            router.push({ name: "main" });
          }
        } catch (userInfoError) {
          console.error("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", userInfoError);
          router.push({ name: "signUp" });
        }
      }
    }
  } catch (error) {
    console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
    alert("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    router.push({ name: "login" });
  }
};

// URLì—ì„œ ì¹´ì¹´ì˜¤ ì¸ê°€ ì½”ë“œ í™•ì¸ (ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ)
onMounted(() => {
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) {
    handleKakaoCallback(code);
  }
});
</script>