<template>
    <div class="signup">
    <div class="rectangle-21"></div>
    <div class="frame-2">
      <div class="rectangle-22"></div>
      <router-link to="/main">
        <div class="tong">TONG</div>
      </router-link>
      <div class="frame-3">
  <div class="id">
    <!-- idÏôÄ name ÏÜçÏÑ± Ï∂îÍ∞Ä -->
    <input 
      type="text" 
      v-model="userId" 
      placeholder="ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
      class="input-field" 
      id="userId" 
      name="userId" 
    />
  </div>
  <div class="password">
    <!-- idÏôÄ name ÏÜçÏÑ± Ï∂îÍ∞Ä -->
    <input
      :type="passwordType"
      v-model="userPassword"
      placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
      class="input-field"
      id="userPassword"
      name="userPassword"
    />
    <span class="toggle-password" @click="togglePasswordVisibility" style="font-size: 28px;">
      {{ isPasswordVisible ? "üîë" : "üîí" }}
    </span>    
  </div>
  <div class="login-btn">
    <button type="button" @click="login" class="login-button">Î°úÍ∑∏Ïù∏</button>
  </div>
  <img
      src="https://image-resource.creatie.ai/142625939968981/142625939968983/c131a7373ebf8184425abc238dab0d0b.png"
      class="kakao-login-large-narrow-1"
      @click="redirectToKakaoLogin"
    />
</div>



            <div class="frame-5">
                <div class="group-104">
                    <router-link to="/signUp">
                            <div class="text--3">
                                ÌöåÏõêÍ∞ÄÏûÖ
                            </div>
                    </router-link>
                    <div class="text--with-kakao">
                        ÌöåÏõêÍ∞ÄÏûÖ with KAKAO
                    </div>
                </div>
            </div>

        </div>
    </div>
</template>


<style lang="scss">
    .signup {
        background-image: url('../assets/images/background.png'); /* Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°úÎ•º ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî */
  background-size: cover;   /* Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ•º Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Ïóê ÎßûÍ≤å Ï°∞Ï†ï */
  background-position: center; /* Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï§ëÏïôÏóê ÏúÑÏπòÌïòÎèÑÎ°ù ÏÑ§Ï†ï */
  background-repeat: no-repeat; /* Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Î∞òÎ≥µ Î∞©ÏßÄ */


    position: relative;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100vh;
    box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
    overflow: hidden;
    .rectangle-21 {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100vh;
        background: linear-gradient(180deg, rgba(47, 47, 47, 0.8) 0%, rgba(78, 78, 78, 0.8) 50%, rgba(149, 149, 149, 0.8) 100%);
    }
    .group {
        position: absolute;
        top: 1.37%;
        left: 0.69%;
        right: -0.14%;
        bottom: 5.47%;
    }
    .group-52 {
        position: absolute;
        top: 1.37%;
        left: 0.69%;
        right: -0.14%;
        bottom: 5.47%;
    }
    .frame-2 {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 807px;
        height: 871px;
        border-radius: 20px;
        overflow: hidden;
        transform: translate(-50%, -50%);  /* ÌôîÎ©¥ Ï§ëÏïôÏúºÎ°ú Ïù¥Îèô */
        .rectangle-22 {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, rgba(197, 197, 197, 0.21) 0%, rgba(197, 197, 197, 0.21) 6%, rgba(113, 113, 113, 0.21) 46%, rgba(95, 95, 95, 0.21) 100%);
        }
        .tong {
            z-index: 2;
            position: absolute;
            top: 12px;
            left: 309.5px;
            width: 190px;
            height: 134px;
            color: #E2495B;
            white-space: nowrap;
            font-family: "Jockey One";
            font-size: 96px;
            line-height: 134px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;

            transition: transform 0.3s ease;

            &:hover {
            transform: scale(1.05);
        }
        }
        
        .frame-3 {
    z-index: 1;
    position: absolute;
    top: 121px;
    left: 71px;
    width: 676px;
    height: 558px;
    border-radius: 10px;
    overflow: hidden;
}

.id {
    position: absolute;
    top: 85px;
    left: calc(100% - 676px + 106px);
    width: 463px;
    height: 79px;
    border-radius: 10px;
    border: 3px solid #FFFFFF;
    display: flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.2);
}

.password {
    position: absolute;
    top: 221px;
    left: 106px;
    width: 463px;
    height: 79px;
    border-radius: 10px;
    border: 3px solid #FFFFFF;
    display: flex;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.2);
}

.input-field {
    width: 100%;
    height: 100%;
    padding: 0 20px;
    background: transparent;
    border: none;
    outline: none;
    color: #FFFFFF;
    font-size: 28px;
    font-family: "Jockey One";
    line-height: 22px;
    font-weight: 400;
    border-radius: 10px;
    color: black;
}

/* Î°úÍ∑∏Ïù∏ Î≤ÑÌäº */
.login-btn {
    position: absolute;
    top: 325px;
    left: calc(100% - 676px + 107px);
    width: 463px;
    height: 79px;
    border-radius: 10px;
    background: rgba(226, 73, 91, 0.9);
    border: 1px solid rgba(226, 73, 91, 0);
    display: flex;
    align-items: center;
    justify-content: center;
}

.login-button {
    width: 100%;
    height: 100%;
    background: transparent;
    color: #FFFFFF;
    font-size: 36px;
    font-family: "Jockey One";
    border: none;
    cursor: pointer;
    border-radius: 10px;
    text-align: center;
}

.text--2 {
    position: absolute;
    top: 340px;
    left: calc(100% - 676px + 289px);
    width: 99px;
    height: 50px;
    color: #FFFFFF;
    white-space: nowrap;
    font-family: "Jockey One";
    font-size: 36px;
    line-height: 50px;
    font-weight: 400;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.kakao-login-large-narrow-1 {
    position: absolute;
    top: 418px;
    left: 107px;
    width: 463px;
    height: 76px;
    border-radius: 10px;
    object-fit: cover;
}


        .frame-5 {
            position: absolute;
            left: calc(100% - 807px + 101px);
            bottom: 85px;
            width: 606px;
            height: 82px;
            overflow: hidden;
            .group-104 {
                position: absolute;
                top: 30px;
                left: 195px;
                width: 264px;
                height: 22px;
                .text--3 {
                    position: absolute;
                    top: 0px;
                    left: 0px;
                    width: 57px;
                    height: 22px;
                    color: #FFFFFF;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
                .text--4 {
                    position: absolute;
                    top: 0px;
                    left: 0px;
                    width: 57px;
                    height: 22px;
                    color: #FFFFFF;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
                .text--with-kakao {
                    position: absolute;
                    top: 0px;
                    left: 142px;
                    width: 122px;
                    height: 22px;
                    color: #FFFFFF;
                    white-space: nowrap;
                    font-family: "Jockey One";
                    font-size: 16px;
                    line-height: 22px;
                    font-weight: 400;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                }
            }
        }
    }
}
</style>



<script setup>
import { ref, computed, onMounted } from "vue";
import axios from "axios";
import { useRouter } from "vue-router";
import { useUserStore } from '../stores/user';

// ÏÉÅÌÉú Î≥ÄÏàòÎì§
const userId = ref("");
const userPassword = ref("");
const isPasswordVisible = ref(false);
const router = useRouter();
const userStore = useUserStore();

// ÎπÑÎ∞ÄÎ≤àÌò∏ ÌÉÄÏûÖ computed ÏÜçÏÑ±
const passwordType = computed(() => (isPasswordVisible.value ? "text" : "password"));

// ÎπÑÎ∞ÄÎ≤àÌò∏ ÌÜ†Í∏Ä Ìï®Ïàò
const togglePasswordVisibility = () => {
  isPasswordVisible.value = !isPasswordVisible.value;
};

// ÏùºÎ∞ò Î°úÍ∑∏Ïù∏ Ìï®Ïàò
const login = async () => {
  // ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
  if (!userId.value || !userPassword.value) {
    alert("ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  try {
    // Î°úÍ∑∏Ïù∏ ÏöîÏ≤≠
    const response = await axios.post("http://localhost:8080/api/user/signIn", {
      userId: userId.value,
      password: userPassword.value,
    });


    // ÏÑúÎ≤Ñ ÏùëÎãµ ÌôïÏù∏
    if (response.data && response.data["access-token"]) {
      // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ
      alert("Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!");
      // JWT ÌÜ†ÌÅ∞ Ï†ÄÏû•
      userStore.saveTokenToStorage(response.data["access-token"]);
      // Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
      router.push({ name: "main" })
        .then(() => {
          console.log("ÎùºÏö∞ÌåÖ ÏôÑÎ£å:", router.currentRoute.value.name);
        })
        .catch((error) => {
          console.error("ÎùºÏö∞ÌåÖ Ïò§Î•ò:", error);
        });
    } else {
      alert(response.data.message || "Î°úÍ∑∏Ïù∏ Ïã§Ìå®. ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
    }
  } catch (error) {
    console.error("Î°úÍ∑∏Ïù∏ Ïò§Î•ò:", error);
    alert("Î°úÍ∑∏Ïù∏ Ïã§Ìå®. ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
  }
};


// Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Î¶¨Îã§Ïù¥Î†âÌä∏
const redirectToKakaoLogin = () => {
  const KAKAO_CLIENT_ID = '0fd06d3411cbcfb4f97b0eb93baedd48';
  const REDIRECT_URI = 'http://localhost:8080/oauth2/kakao';
  
  // Ïπ¥Ïπ¥Ïò§ Ïù∏Í∞Ä ÏΩîÎìú ÏöîÏ≤≠ URL ÏÉùÏÑ±
  const kakaoAuthUrl = 'https://kauth.kakao.com/oauth/authorize';
  const params = {
    client_id: KAKAO_CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'code',
  };
  const query = new URLSearchParams(params).toString();
  const finalUrl = `${kakaoAuthUrl}?${query}`;
  
  // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
  window.location.href = finalUrl;
};

// Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ ÏΩúÎ∞± Ï≤òÎ¶¨ Ìï®Ïàò
const handleKakaoCallback = async (code) => {
  try {
    // Î∞±ÏóîÎìúÏóê Ïπ¥Ïπ¥Ïò§ Ïù∏Í∞Ä ÏΩîÎìú Ï†ÑÏÜ°
    const response = await axios.get(`http://localhost:8080/oauth2/kakao?code=${code}`);
    
    if (response.data) {
      try {
        // JSON Î¨∏ÏûêÏó¥ÏùÑ ÌååÏã±
        const responseData = typeof response.data === 'string' 
          ? JSON.parse(response.data) 
          : response.data;

        // Ïπ¥Ïπ¥Ïò§ Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Ï†ÄÏû•
        if (responseData.access_token) {
          // sessionStorageÏóê Ïπ¥Ïπ¥Ïò§ Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Ï†ÄÏû•
          sessionStorage.setItem('kakao-access-token', responseData.access_token);
          // userStoreÎ•º ÌÜµÌïú Ï†ÄÏû•ÎèÑ Ìï®Íªò ÏàòÌñâ
          userStore.saveKakaoTokenToStorage(responseData.access_token);
          console.log('Ïπ¥Ïπ¥Ïò§ Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }


        // Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
        router.push({ name: "main" });
      } catch (parseError) {
        console.error("ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:", parseError);
        alert("Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
      }
    }
  } catch (error) {
    console.error("Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ïò§Î•ò:", error);
    alert("Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    router.push({ name: "login" });
  }
};

// URLÏóêÏÑú Ïπ¥Ïπ¥Ïò§ Ïù∏Í∞Ä ÏΩîÎìú ÌôïÏù∏ (Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú)
onMounted(() => {
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) {
    handleKakaoCallback(code);
  }
});
</script>